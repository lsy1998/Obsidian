## 作用
计算税收申报。该函数包含多个游标，用于检索指定日期范围内的相关数据，例如**前一工资期内的税前收入**、**免税收入**和**特殊扣除金额**等，以及**当前工资期内的应税收入**，**专项扣除金额**等。此外，此函数还获取了员工的v_tax_group，如果该员工没有定义税收组别，则将其设置为NULL。

如果`v_tax_group`不为空且不等于**c_expat_tax_group**<font color="#9bbb59">(EXPAT)</font>，则执行以下步骤：
1.  删除[[pr_tax_return_dtl]]表中指定条件的数据；
2.  删除[[pr_spec_tax_deduct_dtl]]表中指定条件的数据;
3.  根据指定条件获取相应的计税周期信息，并计算出对应的起始和结束日期。

如果`piv_pay_period_group`等于**c_chi_gsm_pay_period_group**<font color="#9bbb59">(CHI_GSM)</font>或**c_cdc_pay_period_group**<font color="#9bbb59">(CDC)</font>，则直接根据当前的pay_period确定起始和结束日期； 否则需要查询[[pr_pay_period_defn]]表来获取另外两种情况下的起始和结束日期。

1.获取当前员工的薪资定义 
2.获取员工的控制支付期间情况 
3.获取税期内总应纳税所得额 
4.获取之前支付周期中应纳税所得额、免税的工资扣除数、总扣除额

如果员工是重新雇用的，则个人所得税和旧的工作号码合并。它会从旧的工资中查询最后一个个税记录，并将其加入到当前工资记录中计算出应纳税所得额、免税的工资扣除数和总扣除额。

计算当前员工在应纳税期间内的**应纳税所得额**和**总专项扣除金额**。首先打开一个游标 `cur_curr_taxable_income`，获取当前员工的当期应纳税所得额，并将其赋值给变量 `n_curr_taxable_income`。然后计算总应纳税所得额 `n_tot_taxable_income`，将其设为(上一期的应纳税所得额+当前期的应纳税所得额)<font color="#9bbb59">(cur_curr_taxable_income + n_curr_taxable_income)</font>。

接着通过一个循环，**依次处理每一种专项扣除项**。对于每一种专项扣除项，在此基础上，
先判断其生效时间与实际开始时间与当前周期的关系，
再根据不同情况计算该项专项扣除的所涉及的**应纳税工资月份数** `n_tot_no_of_pay_period` 和**月度专项扣除金额** `n_sum_of_spec_deduct_amt`。
最后根据是否存在“扣发工资”（指因违规被扣留的工资）的情况，计算总专项扣除金额 `n_tot_spec_deduct_amt`。

在一个 for 循环中，
对员工的专项扣除进行插入操作，将各类专项扣除的金额分别插入到 PR_SPEC_TAX_DEDUCT_DTL 表中。
之后，在一个 SELECT 语句中获取当前员工的税率和速算扣除数，并将其赋值给变量 `n_taxable_rate` 和 `n_speed_cal_amount`。
接下来，根据员工应纳税所得额与免税额的关系和是否具有“停薪留职”情况，计算员工的免税额并赋值给变量 `n_tot_exempted_taxable_salary`。
最后，通过 if 判断语句确定员工需要交多少个人所得税，如果应纳税所得额大于免税额，则计算相应税额；否则，不需要交税，税额为 0。无论如何，最后都会将计算出的税额赋值给变量 `n_tax_amt`


从数据库中查找符合条件的税金信息。
计算员工的应纳税金额。
计算员工的应退税金额。
计算员工的总特定扣除额。
计算员工的总减免额。
将税金计算结果插入到 [[pay_results]] 表中。
将税务申报细节插入到 [[pr_tax_return_dtl]] 表中。
如果税金小于等于0，则跳过第7步和第8步，并进行步骤10。
调用程序 pkg_tax.[[fnc_g_spec_tax_retn_cal]] 计算外籍员工的特殊税务申报细节，并将结果插入到相应的数据库表中